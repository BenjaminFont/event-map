# Implementation Plan: Extract Map Icon Factory

**Spec:** `specs/refactoring-extract-map-icons.md`

## Implementation Steps

### Step 1: Create `src/utils/mapIcons.ts`

Create a new utility module with two exported functions. This is the core of the refactoring.

**`createSingleMarkerIcon(eventType: string): L.Icon`**
- Lift the body of `getSingleMarkerIcon` (lines 108-120 of `EventMap.vue`) directly into this function.
- Keep the same SVG path, `encodeURIComponent` encoding, icon sizes, and anchor points.
- Import `EVENT_TYPE_COLORS` and `EventType` from `../types/event` for color lookup with the `#6B7280` fallback.

**`createClusterIcon(count: number, events: Event[]): L.Icon | L.DivIcon`**
- Lift the body of `getClusterIcon` (lines 62-106) directly into this function.
- The "most common event type" logic (lines 64-76) moves with it.
- Both the single-event branch (`L.icon`) and multi-event branch (`L.divIcon`) stay intact.
- Import `Event` type for the `events` parameter.

**Internal helpers (not exported):**
- Extract the shared SVG pin path string (`M12 0C7.58...`) into a module-level constant to eliminate duplication across the three places it appears.
- Optionally extract a small `buildPinSvgUrl(color: string): string` helper that wraps the `data:image/svg+xml,...` encoding, since the single-marker icon and the single-event cluster branch use identical logic.

**Dependencies:** `leaflet` (for `L.icon`, `L.divIcon`), `../types/event` (for `EVENT_TYPE_COLORS`, `EventType`, `Event`).

### Step 2: Update `src/components/EventMap.vue`

- Remove the `getClusterIcon` and `getSingleMarkerIcon` function definitions (lines 62-120).
- Add import: `import { createClusterIcon, createSingleMarkerIcon } from '../utils/mapIcons'`
- Replace usage on line 144: `getClusterIcon(...)` becomes `createClusterIcon(...)`.
- Replace usage on line 174: `getSingleMarkerIcon('Other')` becomes `createSingleMarkerIcon('Other')`.
- The `EVENT_TYPE_COLORS` import stays because it is still used directly in the popup template (line 159).
- The `Event` type import stays because it is used elsewhere in the component.
- The `L` import can be removed if no other Leaflet usage remains in the script block. Check whether `LeafletMouseEvent` type import is sufficient to keep `leaflet` referenced -- it is imported as a type separately, so the default `L` import can be dropped.

### Step 3: Verify CSS is unaffected

The `.cluster-icon`, `.cluster-marker`, and `.cluster-count` styles in `EventMap.vue` are in a **non-scoped** `<style>` block (lines 180-221). These styles target the HTML generated by `createClusterIcon` and must remain in `EventMap.vue` since they are DOM styles applied at runtime. No changes needed here -- just confirm they still apply correctly.

## Key Decision Points

1. **Function signature for `createClusterIcon`:** The spec suggests `(count, eventTypes)` but the current implementation takes `(count, events: Event[])` and derives types internally. Keeping the `events: Event[]` signature is simpler and avoids forcing callers to pre-compute type distributions. The "most common type" logic belongs in the icon factory since it is presentation-specific.

2. **Shared SVG path constant:** The pin path string appears three times in the current code. Extracting it into a single `PIN_PATH` constant within `mapIcons.ts` reduces duplication and makes future shape changes a one-line edit.

3. **Removing `import L` from EventMap.vue:** After extraction, `EventMap.vue` no longer calls `L.icon()` or `L.divIcon()` directly. The only Leaflet reference left is `LeafletMouseEvent` which is a type-only import. The default `L` import can be removed to keep imports clean.

## Testing Strategy

**Primary validation: Visual regression (manual).**
- Run `npm run dev` and visually compare map markers before and after.
- Check single markers, single-event clusters, and multi-event clusters.
- Verify each of the 9 event types renders with the correct color.

**Unit testing hints:**
- The pure functions in `mapIcons.ts` are straightforward to unit test if unit tests are added later.
- `createSingleMarkerIcon` can be tested by asserting the returned `L.Icon` has the expected `iconUrl` containing the correct color hex and SVG path.
- `createClusterIcon` with `count === 1` should return an `L.Icon`; with `count > 1` should return a `L.DivIcon` whose `html` contains the count and correct color.
- Edge case: events array with mixed types -- the icon should use the color of the most frequent type.
- Edge case: unknown event type string -- should fall back to `#6B7280`.

**Build verification:**
- `npm run build` must pass with no type errors.

## Risks and Unknowns

- **CSS coupling:** The `cluster-marker` HTML structure in the `L.divIcon` must match the non-scoped CSS in `EventMap.vue` exactly. If the HTML changes even slightly during extraction (e.g., extra whitespace in class names), styles could break. Copy the HTML template string verbatim.
- **Leaflet import in utility module:** Leaflet is typically a large library. Importing it in a utility module should be fine since it is already a project dependency and tree-shaking is not a concern for Leaflet. However, confirm that `import L from 'leaflet'` works in a non-component `.ts` file with the current build configuration (it should, given the same import works in `EventMap.vue`).
